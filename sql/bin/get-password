#!/usr/bin/php
<?php

$host = 'sql.mit.edu';
$env_user = getenv('USER');
$home = '/mit/'.$env_user;

$cnfPath = $home.'/.sql/my.cnf';

function getMyCnfInfo($path) {
if (file_exists($path)) {
	global $env_user;
	$cnfFile = file_get_contents($path);
	preg_match('/\[mysql\][^\[]*host=([^\n]*)/',$cnfFile,$match);
	$host = $match[1];
	preg_match('/\[mysql\][^\[]*user=([^\n]*)/',$cnfFile,$match);
	$user = $match[1];
	preg_match('/\[mysql\][^\[]*password=([^\n]*)/',$cnfFile,$match);
	$password = $match[1];
	if (empty($host)) $host = 'sql.mit.edu';
	if (empty($user)) $user = $env_user;
	if (empty($password)) $password = 'password';
	return array($host,$user,$password);
}
}

$cnfinfo = getMyCnfInfo($cnfPath);
if (is_array($cnfinfo)) {
	list($h,$u,$p) = $cnfinfo;
	echo "$h\t$u\t$p";
	exit;
}

$sql_status = file_get_contents('http://sql.mit.edu/~sql/main/do/batch/status?u='.$env_user);
switch($sql_status) {
	case 1:
		$myPassword = `/usr/bin/sql-signup`;
        file_put_contents($cnfPath, "[mysql]\nhost=$host\nuser=$env_user\npassword=$myPassword\n");
        $cnfinfo = getMyCnfInfo($cnfPath);
        if (is_array($cnfinfo)) {
            list($h,$u,$p) = $cnfinfo;
    	    echo "$h\t$u\t$p";
        }
		break;
	case 0:
}
